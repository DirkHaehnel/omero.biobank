#!/bin/bash

# Import marker definitions and alignments for a marker set

# This example assumes that suitable tsv files for importing marker
# definitions and alignments exist in the current working
# directory. The former can be generated by converting chip annotation
# files with tools such as snp_manager/convert_affy, while the latter
# can be produced by the snp_manager suite with the aid of an external
# sequence aligner. The script assumes that the aforementioned files
# are named, respectively, as follows:
#
# ${MSET}_marker_def.tsv
# ${MSET}_${REF_GENOME}.tsv
#
# where MSET and REF_GENOME are configurable environment variables.
#
# NOTE: a dummy study and device object are automatically generated to
# satisfy importer requirements.

die() {
    echo $1 1>&2
    exit 1
}

BASEDIR=$(cd $(dirname ${BASH_SOURCE}); pwd; cd - >/dev/null)

export OME_HOST=${OME_HOST:="localhost"}
export OME_USER=${OME_USER:="root"}
export OME_PASSWD=${OME_PASSWD:="romeo"}

MSET=${MSET:="affy_na32"}
MAKER=${MAKER:="Affymetrix"}
MODEL=${MODEL:="GenomeWide-6.0"}
RELEASE=${RELEASE:="na32"}
REF_GENOME=${REF_GENOME:="hg19"}
STUDY=${STUDY:="dummy"}
DEVICE=${DEVICE:"dummy"}

BIOBANK_HOME=${BIOBANK_HOME:=${BASEDIR}/..}
IMPORTER="${BIOBANK_HOME}/tools/importer --operator ${USER} --loglevel=DEBUG"
KB_QUERY="${BIOBANK_HOME}/tools/kb_query --operator ${USER} --loglevel=DEBUG"

WORK=${WORK:=./work}

mdef_tag=${MSET}_marker_def
align_tag=${MSET}_${REF_GENOME}


mkdir -p ${WORK}

#--- generate study ---
cat <<EOF >${WORK}/study.tsv
label	description
${STUDY}	test
EOF
${IMPORTER} -i ${WORK}/study.tsv -o ${WORK}/study_map.tsv \
    study || die "import study failed"
#----------------------

${IMPORTER} -i ./${mdef_tag}.tsv \
    -o ${WORK}/${mdef_tag}_map.tsv markers_set \
    --maker=${MAKER} --model=${MODEL} --release=${RELEASE} \
    --study ${STUDY} --label ${MSET} || die "import marker set failed"

#--- generate device ---
cat <<EOF >${WORK}/device.tsv
device_type	label	maker	model	release	markers_set
GenotypingProgram	${DEVICE}	foo	bar	0.1.0	${MSET}
EOF
${KB_QUERY} -o ${WORK}/device_vids.tsv map_vid -i ${WORK}/device.tsv \
    --source-type SNPMarkersSet --column markers_set,markers_set \
    --study ${STUDY} || die "map vid of marker set on device file failed"
${IMPORTER} -i ${WORK}/device_vids.tsv -o ${WORK}/device_map.tsv device \
    --study ${STUDY} || die "import device failed"
#----------------------

${KB_QUERY} -o ${WORK}/${align_tag}_vids.tsv map_vid \
    -i ./${align_tag}.tsv --source-type Marker \
    --column marker_vid,marker_vid --study ${STUDY} \
    --marker-set ${MSET} || die "map vid on marker alignments failed"

${IMPORTER} -i ${WORK}/${align_tag}_vids.tsv \
    -o ${WORK}/${align_tag}_map.tsv \
    marker_alignment --markers-set ${MSET} --ref-genome=${REF_GENOME} \
    --study ${STUDY} || die "import marker alignments failed"
