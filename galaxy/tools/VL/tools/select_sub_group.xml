<tool id="vl_tools_select_sub_group" name="VLT.select_sub_group">
  <description>
    Selects groups of individuals.
  </description>
  <command interpreter="python">
    kb_query.py
    #if $advanced_configuration.configuration_level == 'advanced'
      --host=${advanced_configuration.vl_host}
      --user=${advanced_configuration.vl_user}
      --passwd=${advanced_configuration.vl_passwd}
    #else
      --host=$__app__.config.omero_default_host
      --user=$__app__.config.omero_default_user
      --passwd=$__app__.config.omero_default_passwd
    #end if
    --operator=galaxy
    --ofile=${output1}
    --loglevel=$__app__.config.vl_loglevel
    --logfile=${logfile}
    selector
    #if str($study) != 'use_all'
       --study=${source_type.study}
    #end if
    --group-label=$group_label
    --total-number=$total_number
    --male-fraction=$male_fraction
    --reference-disease=$reference_disease
    --control-fraction=$control_fraction
    #if str($required_datasample) !=  'unselect'
      --required-datasample=$required_datasample
    #end if
    #if int($seed) != 0
      --seed=$seed
    #end if 
  </command>  
  <inputs>
    <param name="study" type="select" label="study label" 
	   help="Select only between individuals enrolled in this study. 
		 See below.">    
      <options from_parameter="tool.app.known_studies" 
	       transform_lines="[ &quot;%s%s%s:%s&quot; 
				% ( l[0], self.separator, l[0], l[1][:40] ) 
				for l in obj ]">
	<column name="value" index="0"/>
	<column name="name" index="1"/>
	<filter type="sort_by" column="0"/>
	<filter type="add_value" name="Use all individuals" 
		value="use_all" index="0"/>
      </options>
    </param>

    <param name="group_label" type="text" value="fake-group" 
	   size="30" label="Group label"
	   help="the new group (it is actually a study) label"
	   />

    <param name="total_number" type="integer"
	   label="total number of individuals requested"
	   help="It will be cut to the largest number of individuals satisfying
		 the required constraints."
	   value="100"
	   />

    <param name="male_fraction" type="float"
	   value="0.5" 
	   label="Male fraction"
	   help="The fraction of male individuals.">
      <validator type="in_range" message="should be between 0 and 1" 
		 min="0.0" max="1.0"/>
    </param>

    <!-- FIXME we should be getting this from some list of known
         diagnosis codes file.
    -->
    <param name="reference_diagnosis" type="select" 
	   label="Phenotypic profile (diagnosis, for the time being)">
	<option value="icd10-cm:E10">Type 1 Diabetes</option>	
	<option value="icd10-cm:G35">Multiple Sclerosis</option>
      </param>

    <param name="control_fraction" type="float"
	   value="0.5" 
	   label="Control fraction"
	   help="The fraction of control individuals.">
      <validator type="in_range" message="should be between 0 and 1" 
		 min="0.0" max="1.0"/>
    </param>

    <!-- FIXME we should be getting this directly 
         from bl.vl.app.kb_query.selector.SUPPORTED_DATA_SAMPLE_TYPES -->
    <param name="required_datasample" type="select"
	   label="Required datasample type">
	<option value="unselect">none</option>
	<option value="AffymetrixCel">AffymetrixCel</option>	
	<option value="IlluminaBeadChipAssay">IlluminaBeadChipAssay</option>
      </param>
	   
    <param name="seed" type="int" value="0"
	   lavel="Random seed"
	   help="Seed for the random number generator. A value of 0 
                 will force to the default initialization.">
      <validator type="in_range" message="should be non negative" 
		 min="0.0" max="inf"/>
    </param>

    <!-- ************************************************** -->
    <conditional name="advanced_configuration">
      <param name="configuration_level" type="select" 
	     label="Configuration level">
	<option value="default" selected="true">Default configuration</option>	
	<option value="advanced">Advanced configuration</option>
      </param>
      <when value="default"/>
      <when value="advanced">
	<param name="vl_host" size="40" type="text" value="biobank05.crs4.it" 
	       label="Omero/VL host"/>
	<param name="vl_user" size="20" type="text" value="galaxy" 
	       label="Omero/VL user"/>
	<param name="vl_passwd" size="20" type="text" value="What?Me worry?" 
	       label="Omero/VL passwd"/>
      </when>
    </conditional>
  </inputs>

  <outputs>
    <data format="tabular" name="output1" label="${tool.name}.selected"/>
    <data format="txt" name="logfile"     label="${tool.name}.logfile"/>
  </outputs>
  <help>
It will select a group of individuals from a specific group (from all
avalable individuals, if no group is selected). The selection is
controlled by the following parameters:

  * total number of individuals selected
  * male fraction
  * reference disease
  * control fraction
  * presence of specific datasets

The results will be presented as a file that can be used to generate a
new group (actually a study). The file will have the following columns::

    study label individual
    XXX   0001  V20940239409
    XXX   0002  V20940239509
    XXX   0003  V20940239609
    XXX   0004  V20940239709
    ...

  where study is the name of the new study
  </help>

</tool>