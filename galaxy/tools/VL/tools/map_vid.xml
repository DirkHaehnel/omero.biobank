<tool id="vl_tools_map_vid" name="VLT.map_vid">
  <description>
    Map labels of objects known to Omero/VL to their VID
  </description>
  <command interpreter="python">
    map_vid.py
    ${selected_column}
    ${new_column_name}
    ${input1}
    #if $advanced_configuration.configuration_level == 'advanced'
      --host=${advanced_configuration.vl_host}
      --user=${advanced_configuration.vl_user}
      --passwd=${advanced_configuration.vl_passwd}
    #end if
    --operator=galaxy
    --ofile=${output1}
    --loglevel=$__app__.config.vl_loglevel
    --logfile=${logfile}
    map_vid
    --ifile=${input1}
    --source-type=${source_type.source_type}
    #if $source_type.source_type == 'Individual'
       #if str($source_type.study) != 'use_provided'
          --study=${source_type.study}
       #end if
    #end if
  </command>  
  <inputs>
    <param format="tabular" name="input1" type="data"
	   label="A tabular dataset with one 'label' column. See below."/>

    <param name="selected_column" label="labelled source column" 
	   help="fixme, this has to be explained..."
	   type="data_column" data_ref="input1" />
    <param name="new_column_name" label="label for the replacement column" 
	   type="text" size="40" value="source" />
    
    <conditional name="source_type">
      <param name="source_type" type="select" label="Select source type"
	     help="Choose from the possible source types. See below."> 
	<option value="Tube">Tube</option>
	<option value="Individual">Individual</option>
	<option value="TiterPlate">TiterPlate</option>
	<option value="PlateWell">PlateWell</option>
	<option value="Chip">Chip</option>
	<option value="Scanner">Scanner</option>
	<option value="DataSample">DataSample</option>
	<option value="SoftwareProgram">SoftwareProgram</option>
	<option value="SNPMarkersSet">SNPMarkersSet</option>
	<option value="DataCollectionItem">DataCollectionItem</option>
	<option value="FlowCell">FlowCell</option>
	<option value="Lane">Lane</option>
      </param>
      <!-- <when value="Tube"/> -->
      <!-- <when value="TiterPlate"/> -->
      <!-- <when value="PlateWell"/> -->
      <!-- <when value="Chip"/> -->
      <!-- <when value="Scanner"/> -->
      <!-- <when value="DataSample"/> -->
      <!-- <when value="SoftwareProgram"/> -->
      <!-- <when value="SPNMarkersSet"/> -->
      <!-- <when value="DataCollectionItem"/> -->
      <when value="Individual">
	<param name="study" type="select" label="Study of enrollment" 
	       help="Resolve enrollment in a known study. See below.">    
	  <options from_parameter="tool.app.known_studies" 
		   transform_lines="[ &quot;%s%s%s:%s&quot; 
				    % ( l[0], self.separator, l[0], l[1][:40] ) 
				    for l in obj ]">
	    <column name="value" index="0"/>
	    <column name="name" index="1"/>
	    <filter type="sort_by" column="0"/>
	    <filter type="add_value" name="Records provide study labels" 
		    value="use_provided" index="0"/>
	  </options>
	</param>
      </when>
    </conditional>

    <!-- ************************************************** -->
     <conditional name="wait_for_trigger">
      <param name="enable_trigger" type="boolean" checked="false"
	     label="Wait for another tool to end before running this tool"/>
      <when value="true">
	<param format="txt" name="trigger_file" type="data"
	       label="Select the LOG file that will be used as trigger"/>
      </when>
    </conditional>

    <conditional name="advanced_configuration">
      <param name="configuration_level" type="select" 
	     label="Configuration level">
	<option value="default" selected="true">Default configuration</option>	
	<option value="advanced">Advanced configuration</option>
      </param>
      <when value="default"/>
      <when value="advanced">
	<param name="vl_host" size="40" type="text" value="biobank05.crs4.it" 
	       label="Omero/VL host"/>
	<param name="vl_user" size="20" type="text" value="galaxy" 
	       label="Omero/VL user"/>
	<param name="vl_passwd" size="20" type="text" value="What?Me worry?" 
	       label="Omero/VL passwd"/>
      </when>
    </conditional>
  </inputs>

  <outputs>
    <data format="tabular" name="output1" label="${tool.name}.mapped"/>
    <data format="txt" name="logfile"     label="${tool.name}.logfile"/>
  </outputs>
  <help>

The tool resolves VIDs for the given column and rename the column
iteself with a new label. Usually to map the items' VIDs the simple
item label is necessary but in some cases a special syntax is needed:

* for PlateWell items the pattern is **PLATE_LABEL:WELL_LABEL**

* for DataCollectionItem items the pattern is
  **DATA_COLLECTION_LABEL:ITEM_LABEL**

  </help>

</tool>