<tool id="vl_import_enrollment" name="VLI.enrollment">
  <description>Create new enrollmnents for existing individuals within omero/vl</description>
  <command interpreter="python">
    #if $__app__.config.vl_import_enabled_users.split(',').count($__user_email__) == 1 #importer.py
    #else #unauthorized_access.py
    #end if
    #if str($advanced_configuration.configuration_level) == 'advanced'
      --host=$advanced_configuration.vl_host
      --user=$advanced_configuration.vl_user
      --passwd=$advanced_configuration.vl_passwd
    #end if
    --operator=galaxy
    --ifile=$input1
    --ofile=$output1
    --loglevel=$__app__.config.vl_loglevel
    --logfile=${logfile}
    enrollment
    #if str($study_label) != 'use_provided'
      --study=$study_label
    #end if
  </command>
  <inputs>
    <param format="tabular" name="input1" type="data"
	   label="A tabular dataset with the following columns ..."/>

    <param name="study_label" type="select" label="Context study"
	   help="Choose from already defined studies. See below.">
      <options from_parameter="tool.app.known_studies"
	       transform_lines="[ &quot;%s%s%s:%s&quot;
	                          % (l[0], self.separator, l[0], l[1][:40] )
				  for l in obj ]">
	<column name="value" index="0"/>
	<column name="name" index="1"/>
	<filter type="sort_by" column="0"/>
	<filter type="add_value" name="Records will provide study labels"
		value="use_provided" index="0"/>
      </options>
    </param>
    <conditional name="advanced_configuration">
      <param name="configuration_level" type="select"
	     label="Configuration level">
	<option value="default" selected="true">Default configuration</option>
	<option value="advanced">Advanced configuration</option>
      </param>
      <when value="default"/>
      <when value="advanced">
	<param name="vl_host" size="40" type="text" value="localhost"
	       label="Omero/VL host"/>
	<param name="vl_user" size="20" type="text" value="root"
	       label="Omero/VL user"/>
	<param name="vl_passwd" size="20" type="text" value="What?Me worry?"
	       label="Omero/VL passwd"/>
      </when>
    </conditional>
  </inputs>
  <outputs>
    <data format="tabular" name="output1" label="${tool.name}.mapping"/>
    <data format="txt"     name="logfile" label="${tool.name}.logfile"/>
  </outputs>  
  <help>
Import of new enrollments related to existing individuals.
An enrollment is characterized by the following fields::

 source                              study  label
 V044DE795E7F9F42FEB9855288CF577A77  xxx    id1
 V06C59B915C0FD47DABE6AE02C731780AF  xxx    id2
 V01654DCFC5BB640C0BB7EE088194E629D  xxx    id3

where source must be the VID of an existing Individual object, study a
label of an existing Study object and label the enrollment code for
the patient in the study.

The enrollment sub-operation will retrieve the source individual from
the DB, create a new enrollment related to it and output the VIDs of
newly created enrollments. It is not possible to create two
enrollments with the same code related to the same study, nor is it
possible to enroll a patient twice in the same study, even with
different codes.
  </help>
</tool>